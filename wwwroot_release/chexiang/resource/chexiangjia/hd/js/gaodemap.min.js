var storeInfoData=null;var pageSize=8;var maxEndIndex=null;var cityDistRelMap=new Map();var distStoreRelMap=new Map();var mapObj=null;var storeMakerMap=new Map();var storePopInfoMap=new Map();$(function(){initMapControl();queryStoreInfo("http://weixin.achezhan.com/wemall/restful/getStoreForPC.htm")});function queryStoreInfo(a){$.ajax({type:"get",async:false,url:a,dataType:"jsonp",success:function(b){storeStoreInfoData(b)},error:function(){alert("请刷新")}})}function initMapControl(){mapObj=new AMap.Map("mapContainer",{resizeEnable:true,view:new AMap.View2D({center:new AMap.LngLat(121.472644,31.231706),zoom:11})});windowsArr=new Array();marker=new Array();mapObj.plugin(["AMap.ToolBar"],function(){var a=new AMap.ToolBar();mapObj.addControl(a)})}function displayInMap(d){var c=d.localX;var b=d.localY;var a={map:mapObj,icon:window.mapMakerIcon,position:new AMap.LngLat(c,b)};var f=new AMap.Marker(a);var e=new AMap.InfoWindow({content:"<h3>"+d.storeName+"</h3><div class='map_txt_cn'><p>地址："+d.address+"</p><p>营业时间：<em>"+d.businesstime+"</em></p><p>联系电话："+d.telephone+"</p></div>",size:new AMap.Size(370,0),autoMove:true,offset:{x:0,y:-20}});var g=function(h){e.open(mapObj,f.getPosition())};AMap.event.addListener(f,"click",g);storeMakerMap.put(d.storeId,f);storePopInfoMap.put(d.storeId,e)}function displayStoreInLeftArea(a){var b="<li class='nd2' storeId='"+a.storeId+"'>";b+="<h4>"+a.storeName+"</h4>";b+="<p>地址："+a.address+"</p>";$("#seek .seek_cn .map_cn .shops").append(b)}function openMarkerTipById1(b,a){a.style.background="#CAE1FF";windowsArr[b].open(mapObj,marker[b])}function onmouseout_MarkerStyle(b,a){a.style.background=""}function storeStoreInfoData(d){storeInfoData=d;maxEndIndex=storeInfoData.length-1;for(var e=0;e<storeInfoData.length;e++){var l=storeInfoData[e].cityName;var k=storeInfoData[e].distName;if(StringUtil.isNotEmpty(k)){if(cityDistRelMap.containsKey(l)){var g=cityDistRelMap.get(l);if(g!=null){var b=false;for(var c=0;c<g.length;c++){var h=g[c];if(h==k){b=true;break}}}if(!b){g.push(k);cityDistRelMap.put(l,g)}}else{var g=new Array();g.push(k);cityDistRelMap.put(l,g)}if(distStoreRelMap.containsKey(l)){var f=distStoreRelMap.get(l);f.push(e);distStoreRelMap.put(l,f)}else{var f=new Array();f.push(e);distStoreRelMap.put(l,f)}var a=l+"_"+k;if(distStoreRelMap.containsKey(a)){var f=distStoreRelMap.get(a);f.push(e);distStoreRelMap.put(a,f)}else{var f=new Array();f.push(e);distStoreRelMap.put(a,f)}}}displayCityData("上海市")}function displayCityData(a){var c=cityDistRelMap.keys;var d=$("#js_dealer_city .city-tb ul");for(var b=0;b<c.length;b++){if(a==c[b]){$("#js_dealer_city .city-th .js-city-name").html(a);$(d).append("<li><a class='cur' href='javascript:;'>"+a+"</a></li>")}else{$(d).append("<li><a href='javascript:;'>"+c[b]+"</a></li>")}}displayDistDataAndMap(a);$(d).find("a").click(function(){$(this).parents("ul").find("a").removeClass("cur");$(this).addClass("cur");var e=$(this).html();$("#js_dealer_city .city-th .js-city-name").html($(this).html());displayDistDataAndMap(e)});initCityFn()}function displayDistDataAndMap(b){var a=cityDistRelMap.get(b);var d=$("#seek .seek_cn .area_cn");$(d).html("<a href='javascript:;' class='cur'>全部</a>");for(var c=0;c<a.length;c++){(d).append("<a href='javascript:;' >"+a[c]+"</a>")}$(d).find("a").click(function(){$(this).parent().find("a").removeClass("cur");$(this).addClass("cur");var e=$(this).html();if(e=="全部"){e=""}searchStoreByCityAndDist($("#js_dealer_city .city-th .js-city-name").html(),e)});searchStoreByCityAndDist(b,"")}function searchStoreByCityAndDist(b,f){if(!StringUtil.isNotEmpty(b)){return}var e=b;if(StringUtil.isNotEmpty(f)){e=e+"_"+f}var d=distStoreRelMap.get(e);if(StringUtil.isEmpty(d)){return}mapObj.clearMap();storeMakerMap=new Map();$("#seek .seek_cn .map_cn .shops").html("");for(var c=0;c<d.length;c++){var g=d[c];var a=storeInfoData[g];displayInMap(a);displayStoreInLeftArea(a);if(c==0){mapObj.setZoomAndCenter(11,new AMap.LngLat(a.localX,a.localY))}}$("#seek .seek_cn .map_cn .shops li").click(function(){$(this).parent().find("li").removeClass("cur");$(this).addClass("cur");var h=$(this).attr("storeId");var j=storeMakerMap.get(h);var i=storePopInfoMap.get(h);i.open(mapObj,j.getPosition())})}function Map(){this.keys=new Array();this.data=new Object();this.put=function(a,b){if(this.data[a]==null){this.keys.push(a)}this.data[a]=b};this.get=function(a){return this.data[a]};this.remove=function(a){this.keys.remove(a);this.data[a]=null};this.each=function(d){if(typeof d!="function"){return}var a=this.keys.length;for(var c=0;c<a;c++){var b=this.keys[c];d(b,this.data[b],c)}};this.entrys=function(){var a=this.keys.length;var c=new Array(a);for(var b=0;b<a;b++){c[b]={key:this.keys[b],value:this.data[b]}}return c};this.isEmpty=function(){return this.keys.length==0};this.size=function(){return this.keys.length};this.containsKey=function(a){if(this.data[a]==null){return false}else{return true}};this.containsValue=function(b){for(var a in this.data){if(this.data[a]==b){return true}}return false};this.toString=function(){var c="{";for(var b=0;b<this.keys.length;b++,c+=","){var a=this.keys[b];c+=a+"="+this.data[a]}c+="}";return c}}StringUtil={isNotEmpty:function(a){if(a!=null&&a!=""){return true}else{return false}},isEmpty:function(a){if(a!=null&&a!=""){return false}else{return true}}};